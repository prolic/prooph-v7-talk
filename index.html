<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8" />
    <title>CQRS &amp; Event Sourcing</title>
    <meta name="description" content="CQRS &amp; Event Sourcing Talk" />
    <meta name="author" content="Sascha-Oliver Prolic" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href='https://fonts.googleapis.com/css?family=Cabin+Sketch' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.min.css">
    <link rel="stylesheet" href="bower_components/reveal.js/css/theme/default.css" id="theme">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css" id="highlight-theme">
    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
        document.write( '<link rel="stylesheet" href="bower_components/reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>
    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
<div class="reveal">
<div class="slides">

<section>
    <h1>Hi!</h1>
</section>

<section>
    <img src="assets/img/me.png" alt="me" width="200" height="200">
    <h1>Sascha-Oliver Prolic</h1>
</section>

<section>
    <h2>
        <img
            src="assets/img/prooph-logo.png"
            alt="Prooph components"
            style="margin: -8px;"
        />
        maintainer
    </h2>
</section>

<section>
    <h1>Prooph Event Store v7.0.0</h1>
</section>

<section>
    <h2>Changes & New Features</h2>
    <p class="fragment" data-fragment-index="1">Requires PHP 7.1 (scalar type hints, return types, ...)</p>
    <p class="fragment" data-fragment-index="2">Event Store Interfaces</p>
    <p class="fragment" data-fragment-index="3">Different Event Store Implementations - no adapters</p>
    <p class="fragment" data-fragment-index="4">Implementation details of PDO-EventStore</p>
    <p class="fragment" data-fragment-index="5">Queries & Projections</p>
</section>

<section>
    <h2>Creating an event stream</h2>
    <pre><code class="php">$stream = new Stream(
    new StreamName('test-stream'),
    new ArrayIterator($events),
    ['some' => 'metadata']
);

$eventStore->create($stream);</code></pre>
</section>

<section>
    <h2>Appending to an existing stream</h2>
    <pre><code class="php">$eventStore->appendTo(
    new StreamName('test-stream'),
    new ArrayIterator($event)
);</code></pre>
</section>

<section>
    <h2>Loading events</h2>
    <pre><code class="php">$events = $eventStore->load(
    new StreamName('test-stream')
);

$events = $eventStore->loadReverse(
    new StreamName('test-stream')
);</code></pre>
</section>

<section>
    <pre><code class="php">namespace Prooph\EventStore;

interface EventStore
{
    /* more methods */

    public function load(
        StreamName $streamName,
        int $fromNumber = 1,
        int $count = null,
        MetadataMatcher $metadataMatcher = null
    ): Iterator;

    public function loadReverse(
        StreamName $streamName,
        int $fromNumber = PHP_INT_MAX,
        int $count = null,
        MetadataMatcher $metadataMatcher = null
    ): Iterator;
}</code></pre>
</section>

<section>
    <img src="assets/img/metadatamatcher.jpg" width="720" height="540">
</section>

<section>
    <h2>MetadataMatcher</h2>
    <pre><code class="php">$event = UserCreated::with(['name' => 'John'], 1);
$event = $event->withAddedMetadata('foo', 'bar');
$event = $event->withAddedMetadata('int', 5);

var_dump($event->metadata());

// output

[
    'foo' => 'bar',
    'int' => 5
]</code></pre>
</section>

<section>
    <h2>MetadataMatcher</h2>
    <pre><code class="php">$metadataMatcher = new MetadataMatcher();
$metadataMatcher = $metadataMatcher->withMetadataMatch(
    'foo',
    Operator::EQUALS(),
    'bar'
);
$metadataMatcher = $metadataMatcher->withMetadataMatch(
    'int',
    Operator::GREATER_THAN(),
    4
);

$streamEvents = $eventStore->load(
    $streamName,
    1,
    null,
    $metadataMatcher
);</code></pre>
</section>

<section>
    <h2>Fetch stream metadata</h2>
    <pre><code class="php">$metadata = $eventStore->fetchStreamMetadata(
    new StreamName('test-stream')
);</code></pre>
</section>

<section>
    <h2>Iterating over known streams</h2>
    <pre><code class="php">public function fetchStreamNames(
    ?string $filter,
    ?MetadataMatcher $metadataMatcher,
    int $limit = 20,
    int $offset = 0
): array;
</code></pre>
</section>

<section>
    <h2>Iterating over known streams using regex</h2>
    <pre><code class="php">public function fetchStreamNamesRegex(
    string $filter,
    ?MetadataMatcher $metadataMatcher,
    int $limit = 20,
    int $offset = 0
): array;
</code></pre>
</section>

<section>
    <h2>Fetching stream categories</h2>
    <p>Given stream names:</p>
    <pre><code class="bash">user-123, user-234, user-345, ...</code></pre>
    <pre><code class="bash">todo-123, todo-234, todo-345, ...</code></pre>
    <p>Categories are user & todo</p>
</section>

<section>
    <h2>Fetching stream categories</h2>
    <pre><code class="php">public function fetchCategoryNames(
    ?string $filter,
    int $limit = 20,
    int $offset = 0
): array;
</code></pre>
</section>

<section>
    <h2>Fetching stream categories using regex</h2>
    <pre><code class="php">public function fetchCategoryNamesRegex(
    string $filter,
    int $limit = 20,
    int $offset = 0
): array;
</code></pre>
</section>

<section>
    <h2>Transactions</h2>
    <pre><code class="php">namespace Prooph\EventStore;

interface TransactionalEventStore extends EventStore
{
    public function beginTransaction(): void;

    public function commit(): void;

    public function rollback(): void;

    public function isInTransaction(): bool;
}</code></pre>
</section>

<section>
    <h2>Need event hooks?</h2>
    <pre><code class="php">$eventStore = new ActionEventEmitterEventStore($eventStore);
$eventStore->attach(
    ActionEventEmitterEventStore::EVENT_LOAD,
    function (ActionEvent $event): void {
        // do something
    }
);</code></pre>
</section>

<section>
    <h2>New implementations</h2>
    <p class="fragment" data-fragment-index="1">InMemoryEventStore (for testing)</p>
    <p class="fragment" data-fragment-index="2">MySQLEventStore (no transaction support)</p>
    <p class="fragment" data-fragment-index="3">PostgresEventStore (full transaction support)</p>
</section>

<section>
    <h2>Persistence strategies in PdoEventStore (MySQL & Postgres)</h2>
</section>

<section>
    <pre><code class="php">namespace Prooph\EventStore\Pdo;

interface PersistenceStrategy
{
    public function createSchema(string $tableName): array;

    public function columnNames(): array;

    public function prepareData(Iterator $streamEvents): array;

    public function uniqueViolationErrorCodes(): array;

    public function generateTableName(StreamName $streamName): string;
}</code></pre>
</section>

<section>
    <h2>Default provided persistence strategies</h2>
    <p class="fragment" data-fragment-index="1">MySQLAggregateStreamStrategy</p>
    <p class="fragment" data-fragment-index="2">MySQLSingleStreamStrategy</p>
    <p class="fragment" data-fragment-index="3">MySQLSimpleStreamStrategy</p>
    <p class="fragment" data-fragment-index="4">Postgres...</p>
</section>

<section>
    <h2>AggregateStreamStrategy</h2>
    <p class="fragment" data-fragment-index="1">Used for event sourcing</p>
    <p class="fragment" data-fragment-index="2">One stream per aggregate</p>
</section>

<section>
    <h2>SingleStreamStrategy</h2>
    <p class="fragment" data-fragment-index="1">Used for event sourcing</p>
    <p class="fragment" data-fragment-index="2">One stream per aggregate type</p>
    <p class="fragment" data-fragment-index="3">or one stream for all aggregates</p>
</section>

<section>
    <h2>SimpleStreamStrategy</h2>
    <p class="fragment" data-fragment-index="1">Used outside of event sourcing</p>
    <p class="fragment" data-fragment-index="2">Useful especially for projections</p>
</section>

<section>
    <h1>Queries & <br>Projections</h1>
</section>

<section>
    <h2>Projections in the past</h2>
    <pre><code class="php">namespace Prooph\ProophessorDo\Projection\User;

final class UserProjector
{
    public function onUserWasRegistered(UserWasRegistered $event)
    {
        $this->connection->insert(Table::USER, [
            'id' => $event->userId()->toString(),
            'name' => $event->name(),
            'email' => $event->emailAddress()->toString()
        ]);
    }

    public function onTodoWasPosted(TodoWasPosted $event)
    {
        // ...
    }
}</code></pre>
</section>

<section>
    <h1>Queries</h1>
</section>

<section>
    <pre><code class="php">namespace Prooph\EventStore\Projection;

interface Query
{
    public function init(Closure $callback): Query;
    public function fromStream(string $streamName): Query;
    public function fromStreams(string ...$streamNames): Query;
    public function fromCategory(string $name): Query;
    public function fromCategories(string ...$names): Query;
    public function fromAll(): Query;
    public function when(array $handlers): Query;
    public function whenAny(Closure $closure): Query;
    public function reset(): void;
    public function run(): void;
    public function stop(): void;
    public function getState(): array;
}</code></pre>
</section>

<section>
    <img src="assets/img/too-much.jpg" width="807" height="527">
</section>
    
<section>
    <pre><code class="php">function prepareEventStream(string $name, EventStore $eventStore)
{
    $events = [];
    $events[] = UserCreated::with([
        'name' => 'Alex'
    ], 1);
    for ($i = 2; $i < 50; $i++) {
        $events[] = UsernameChanged::with([
            'name' => uniqid('name_')
        ], $i);
    }
    $events[] = UsernameChanged::with([
        'name' => 'Sascha'
    ], 50);

    $eventStore->create(new Stream(
        new StreamName($name),
        new ArrayIterator($events)
    ));
}</code></pre>
</section>

<section>
    <pre><code class="php">prepareEventStream('user-123', $eventStore);
$query = $projectionManager->createQuery();
$query
    ->init(function (): array {
        return ['count' => 0];
    })
    ->fromStream('user-123')
    ->when([
        'user-name-changed' => function (
            array $state, UsernameChanged $event
        ): array {
            $state['count']++;
            return $state;
        }
    ])
    ->run();

echo $query->getState()['count']; // 49
$query->reset();
$query->run();
</code></pre>
</section>

<section>
    <pre><code class="php">prepareEventStream('user-123', $eventStore);
prepareEventStream('user-234', $eventStore);
$query = $projectionManager->createQuery();
$query
    ->init(function (): array {
        return ['count' => 0];
    })
    ->fromStreams('user-123', 'user-234')
    ->whenAny(
        function (array $state, Message $event): array {
            $state['count']++;
            return $state;
        }
    )
    ->run();

echo $query->getState()['count']; // 100
</code></pre>
</section>

<section>
    <pre><code class="php">prepareEventStream('user-123', $eventStore);
$query = $projectionManager->createQuery();
$query
    ->init(function (): array {
        return ['count' => 0];
    })
    ->fromCategory('user')
    ->whenAny(
        function (array $state, Message $event): array {
            $state['count']++;
            return $state;
        }
    )
    ->run();

// more code
</code></pre>
</section>

<section>
    <pre><code class="php">// more code

$events = [];
for ($i = 51; $i <= 100; $i++) {
    $events[] = UsernameChanged::with([
        'name' => uniqid('name_')
    ], $i);
}
$eventStore->appendTo(
    new StreamName('user-123'),
    new ArrayIterator($events)
);

$query->run();
echo $query->getState()['count']; // 100
</code></pre>
</section>

<section>
    <img src="assets/img/projections.jpg" width="960" height="539">
</section>

<section>
    <h2>Projections in the past</h2>
    <pre><code class="php">namespace Prooph\ProophessorDo\Projection\User;

final class UserProjector
{
    public function onUserWasRegistered(UserWasRegistered $event)
    {
        $this->connection->insert(Table::USER, [
            'id' => $event->userId()->toString(),
            'name' => $event->name(),
            'email' => $event->emailAddress()->toString()
        ]);
    }

    public function onTodoWasPosted(TodoWasPosted $event)
    {
        // ...
    }
}</code></pre>
</section>
    
<section>
    <img src="assets/img/hell.jpg" width="765" height="432">
</section>

<section>
    <img src="assets/img/rescue.jpg" width="750" height="423">
</section>

<section>
    <h1>Projections</h1>
    <p class="fragment" data-fragment-index="1">Projections are like queries, but persistent</p>
    <p class="fragment" data-fragment-index="2">Projections have special additional methods</p>
    <p class="fragment" data-fragment-index="3">linkTo(string $streamName, Message $event)</p>
    <p class="fragment" data-fragment-index="4">emit(Message $event)</p>
</section>

<section>
    <pre><code class="php">interface Projector
{
    // some consts
    public function init(Closure $callback): Projector;
    public function fromStream(string $streamName): Projector;
    public function fromStreams(string ...$streamNames): Projector;
    public function fromCategory(string $name): Projector;
    public function fromCategories(string ...$names): Projector;
    public function fromAll(): Projector;
    public function when(array $handlers): Projector;
    public function whenAny(Closure $closure): Projector;
    public function reset(): void;
    public function stop(): void;
    public function getState(): array;
    public function getName(): string;
    public function emit(Message $event): void;
    public function linkTo(string $streamName, Message $event): void;
    public function delete(bool $deleteEmittedEvents): void;
    public function run(bool $keepRunning = true): void;
}</code></pre>
</section>

<section>
    <pre><code class="php">prepareEventStream('user-123', $eventStore);

$eventStore->create(new Stream(
    new StreamName('foo'),
    new ArrayIterator()
));

$projector = $projectionManager->createProjection('test_projection');

// more code</code></pre>
</section>

<section>
    <pre><code class="php">// more code

$projector
    ->fromStream('user-123')
    ->whenAny(
        function (array $state, Message $event): array {
            $this->linkTo('foo', $event);
            return $state;
        }
    )
    ->run();

echo iterator_count($eventStore->load(
    new StreamName('foo'))->streamEvents()
); // 50

// more code
</code></pre>
</section>

<section>
    <pre><code class="php">// more code

$events = [];
for ($i = 51; $i < 100; $i++) {
    $events[] = UsernameChanged::with([
        'name' => uniqid('name_')
    ], $i);
}
$events[] = UsernameChanged::with([
    'name' => 'Oliver'
], 100);
$eventStore->appendTo(
    new StreamName('user-123'),
    new ArrayIterator($events)
);

// more code
</code></pre>
</section>

<section>
    <pre><code class="php">// more code

$projector
    ->fromStream('user-123')
    ->whenAny(
    function (array $state, Message $event): array {
        $this->linkTo('foo', $event);
        return $state;
    })
    ->run();

echo iterator_count($eventStore->load(
    new StreamName('foo'))->streamEvents()
); // 100</code></pre>
</section>

<section>
    <pre><code class="php">$prepareEventStream('user-123', $eventStore);

$projector = $projectionManager->createProjection('user_created_projection');

$projector
    ->fromStream('user-123')
    ->when([
        'user-created' => function ($state, $event): void {
            $this->emit($event);
        }
    ])
    ->run();
</code></pre>
</section>

<section>
    <h2>Projections, nice!<br>But for what?</h2>
    <p class="fragment" data-fragment-index="1">Create state in minutes without writing a new model</p>
    <p class="fragment" data-fragment-index="2">Indexing events</p>
    <p class="fragment" data-fragment-index="3">Faster event store queries</p>
</section>

<section>
    <h2>Examples</h2>
</section>

<section>
    <h2>Standard-Projections<br>https://github.com/prooph/standard-projections</h2>
</section>

<section>
    <h2>AllStreamProjection</h2>
    <pre><code class="php">
$query->fromStream('$all')
// equals $query->fromAll(), but faster
</code></pre>
</section>

<section>
    <h2>CategoryStreamProjection</h2>
    <pre><code class="php">$prepareEventStream('user-123', $eventStore);
$prepareEventStream('user-234', $eventStore);

$query->fromStream('$ct-user')
// equals $query->fromCategory('user'), but faster
</code></pre>
</section>

<section>
    <h2>MessageName-<br>StreamProjection</h2>
    <pre><code class="php">$query->fromStream('$mn-user-created')
$query->fromStream('$mn-user-changed-name')
</code></pre>
</section>

<section>
    <h1>Use case:</h1>
    <h2>Finding all events coming from user Sascha</h2>
    <pre><code class="php">var_dump($message->metadata());

// output:
array(1) {
  ["username"]=>
  string(6) "Sascha"
}
</code></pre>
</section>

<section>
    <pre><code class="php">$projector = $projectionManager->createProjection('user_sorted_events');

$projection
    ->fromAll()
    ->whenAny(function ($state, Message $event): void {
        $this->linkTo($event->metadata()['username'], $event);
    })
    ->run();
</code></pre>
</section>

<section>
    <h2>ReadModelProjections</h2>
    <pre><code class="php">interface ReadModelProjector
{
    // some consts
    public function init(Closure $callback): ReadModelProjector;
    public function fromStream(string $streamName): ReadModelProjector;
    public function fromStreams(string ...$streamNames): ReadModelProjector;
    public function fromCategory(string $name): ReadModelProjector;
    public function fromCategories(string ...$names): ReadModelProjector;
    public function fromAll(): ReadModelProjector;
    public function when(array $handlers): ReadModelProjector;
    public function whenAny(Closure $closure): ReadModelProjector;
    public function reset(): void;
    public function stop(): void;
    public function getState(): array;
    public function getName(): string;
    public function delete(bool $deleteProjection): void;
    public function run(bool $keepRunning = true): void;
    public function readModel(): ReadModel;
}</code></pre>
</section>

<section>
    <pre><code class="php">interface ReadModel
{
    public function init(): void;

    public function isInitialized(): bool;

    public function reset(): void;

    public function delete(): void;

    public function stack(string $operation, ...$args): void;

    public function persist(): void;
}</code></pre>
</section>

<section>
    <pre><code class="php">$this->prepareEventStream('user-123', $eventStore);

$projector = $projectionManager->createReadModelProjection(
    'test_projection',
    $readModel
);

// more code</code></pre>
</section>

<section>
    <pre><code class="php">// more code

$projector
    ->fromAll()
    ->when([
        'user-created' => function ($state, Message $event) {
            $this->readModelProjection()->insert(
                'name',
                $event->payload()['name']
            );
        },
        'username-changed' => function ($state, Message $event) {
            $this->readModelProjection()->update(
                'name',
                $event->payload()['name']
            );
        }
    ])
    ->run();</code></pre>
</section>

<section>
    <h2>Wait.. what about this ...</h2>
</section>

<section>
    <h2>ProjectionManager</h2>
    <p class="fragment" data-fragment-index="1">Create queries & projectors</p>
    <p class="fragment" data-fragment-index="2">Delete / reset / stop projections</p>
    <p class="fragment" data-fragment-index="3">Fetch projection names</p>
    <p class="fragment" data-fragment-index="4">Fetch projection status</p>
    <p class="fragment" data-fragment-index="5">Fetch projection stream position</p>
    <p class="fragment" data-fragment-index="6">Fetch projection state</p>
</section>

<section>
    <pre><code class="php">interface ProjectionManager
{
    public function createQuery(): Query;
    public function createProjection(
        string $name,
        array $options = []
    ): Projector;
    public function createReadModelProjection(
        string $name,
        ReadModel $readModel,
        array $options = []
    ): ReadModelProjector;
    public function deleteProjection(string $name, bool $deleteEmittedEvents): void;
    public function resetProjection(string $name): void;
    public function stopProjection(string $name): void;
    public function fetchProjectionNames(?string $filter, int $limit = 20, int $offset = 0): array;
    public function fetchProjectionNamesRegex(string $regex, int $limit = 20, int $offset = 0): array;
    public function fetchProjectionStatus(string $name): ProjectionStatus;
    public function fetchProjectionStreamPositions(string $name): array;
    public function fetchProjectionState(string $name): array;
}</code></pre>
</section>

<section>
    <img src="assets/img/heaven.jpg" width="874" height="674">
</section>

<section>
    <h1>Hire me!</h1>
</section>

<section>
    <h2>Contact me</h2>
    <p><a href="https://github.com/prolic" target="_blank">github.com/prolic</a></p>
    <p><a href="https://twitter.com/sasaprolic" target="_blank">Twitter @sasaprolic</a></p>
    <p><a href="https://gitter.im/prooph/improoph" target="_blank">Prooph Gitter Chat (https://gitter.im/prooph/improoph)</a></p>
</section>
    
<section>
    <img src="assets/img/thats-all.jpg" width="700" height="716">
</section>

<section>
    <h2>Thank you!</h2>
    <p><a href="https://prolic.github.io/prooph-v7-talk/" target="_blank">Slides at: https://prolic.github.io/prooph-v7-talk/</a></p>
</section>

</div>
</div>

<script src="bower_components/reveal.js/lib/js/head.min.js"></script>
<script src="bower_components/reveal.js/js/reveal.min.js"></script>
<script>
    // Configure Reveal
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme || 'sky', // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
            { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
            { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
            { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
            // { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
            //{ src: 'bower_components/reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }

            { src: 'js/loadhtmlslides.js', condition: function() { return !!document.querySelector( '[data-html]' ); } }
        ]
    });
</script>

</body>
</html>
